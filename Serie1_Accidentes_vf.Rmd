---
title: "Serie2_PEA_MEX_v"
author: "Sergi"
date: "2023-03-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Serie de tiempo 1 SIN tendencia y SIN estacionalidad: Historico anual Accidentes terrestres en México

Tenemos data anual desde 2005 a 2021 sobre el número de accidentes terrestres que ha habido en México, son 22 datos en total. 
La idea es usar 19 de esos 22 como una especie de "data de entreaniemto" para aplicar los modelos A) De suavizamiento "estático" y B) De "suavizamiento dinámico" o Holt-Winters para posteriormente predecir con cada modelo los valores de los 3 años restantes y poder comparar contra los reales e identificar el mejor modelo entre los dos mencionados para modelar los accidentes terrestres en México 



Primero importamos la data de Accidentes terrestres en MEX
Data obtenida de la página oficial del INEGI:  https://www.inegi.org.mx/temas/accidentes/

```{r}
install.packages("readxl")

library("readxl")


Accidentes_transito_MEX <-read_excel("Accidentes_transito_pp_.xlsx")
```


Revisamos que la data de nacimientos MEX sehay importado correctamente 
```{r}
Accidentes_transito_MEX
summary(Accidentes_transito_MEX)
typeof(Accidentes_transito_MEX)
dim(Accidentes_transito_MEX)
```


Graficamos la "data original" de Accidentes terrestres en México de los últimos años De 2000 a 2018)  

```{r}

plot(Accidentes_transito_MEX$Date, Accidentes_transito_MEX$Num, type="l", main="Data 'original' de Accidentes terrestres en México")
```


## A. Método de "suavizamiento estático"

Comenzaremos tratando la serie con el método estático aplicando el siguiente flujo lógico de trabajo y considerando que estamos en el caso de serie CON TENDECIA y SIN ESTACIONALIDAD: 

1. Se llevará a cabo el "pronóstico puntual" de los siguientes 3 años como la media historica 
2. Se calcularán los intervalos de pronóstico al 95% de confianza 
3. Se calculará el error tipo MAPE entre los valores pronósticados con el "método estático" y los valores reales de la serie de los últimos 6 trimestres


### A.1 Tratamiendo del ruido blanco en la serie y pronostico puntual  

Considerese el siguiente razonamiento acerca de las series del tiempo: 
Serie total = Componente de tendencia + Componente de estacionalidad + Componente estocástico 

En este caso el Componente de estacionalidad = 0 y el  Componente de tendencia = 0, por lo tanto tendríamos 

Serie total Accidentes MEX = Componente estocástico


Calculamos el "ruido blanco de la serie" como la media de los datos hisóricos
```{r}
Accidentes_transito_ruido_blanco <- mean(Accidentes_transito_MEX$Num)
Accidentes_transito_ruido_blanco
```


Una vez teniendo únicamente el componente estocástico de nuestra serie, es posible "extraer los errores" de la serie y conocer así el error estimado (varianza)  y la desviación estandar. 
La idea es que extrayendo de la serie del ruido blanco su media histórica estaríamos determinando la varianza, de la siguiente manera:

Varianza (errores al cuadrado) = Serie original - media de componete estocástico. 


Errores= Valores originales de la serie - Media del componente estocástico o ruido blanco


Se determinan la varianza (errores al cuadrado) de la serie de PEA_MEX y se calcula también la desviación estandar de esos errores 

```{r}
Error_est_accidentes<-Accidentes_transito_MEX$Num-Accidentes_transito_ruido_blanco
head(Error_est_accidentes)
tail(Error_est_accidentes)

##Claculando la desviaicón estandar del error

sd_est_accidentes<-sd(Error_est_accidentes)
sd_est_accidentes

plot(Accidentes_transito_MEX$Date, Error_est_accidentes, type="l", main="Errores al cuadrado (varianza) de la aplicaicón del modelo de 'suavizamiento estático' a la serie de Accidentes terrestres MX ", cex.main=0.6)

```


Se calcula la media de los errores 
```{r}


mean(Error_est_accidentes)
```

Se calcula la varianza  y desviación estandar de los errores 
```{r}
## Se calcula la varianza
var(Error_est_accidentes)

## Se calcula la desviación estandar 
sd_est_accidentes
```

Se tiene una desviación estandar de ~37 mil y una  media muy cercana a cero para los errores lo cual es totalmente concordante con le hecho de que "el ruido blanco" o componente estocástico tiende a tener una distribuión normal y que si a ese ruido blanco se le extrae su media tambien tiende a tener una distribución normal con media cero y en este caso una desviación estandar de  ~37 mil que representa aproximadamente el 10% del valor de la variable a pronosticar y: Número de accidentes terrestres anuales en México.  



Procedamos a observar como se comporta la Distribución de dichos errores:
```{r}
hist(Error_est_accidentes, breaks = 20, col = "lightblue", main = "Frequency Distribution of Accidentes terrestres en Méxcio errors", xlab = "Values", ylab = "Frequency")

```
Se observa como los errores de la serie se acercan a una distribución normal con media cero y desviación estandar de 50,000, a excepción de los valores atípicos del año 2020 derivados de la pandemia de Covid-19.


#### Pronóstico puntual

Recordemos que para este caso donde no hay componente de tendencia ni estacionalidad y el valor de la serie es directamente el ruido blanco. Entonces, solo por cuestión de concordancia definamos a nuestra "mejor estimaicón puntual" como la media histórica de mi serie 

```{r}
estimacion_puntual_accidentes <- mean(Accidentes_transito_MEX$Num)
estimacion_puntual_accidentes

```




Vamos a hacer el pronóstico de la serie de PEA MEX para los próximos 3 años


```{r}
##Creamos un eje x que incluya a los 66 datos + 6 que se pronosticarán
Date_accidentes2<-c(1:22)


## Creamos el vector de datos que incluirá los  datos históricos  sin tendencia + 6 valores NA a pronosticar
accidentes_para_pron<-c(Accidentes_transito_MEX$Num, rep(NA, times=3))


head(accidentes_para_pron)
tail(accidentes_para_pron)


## Entonces el mejor pronóstico que tenemos para esta técnica es la media de la serie historica


Accidentes_pronostico_puntual <- rep(estimacion_puntual_accidentes, times=22)
head(Accidentes_pronostico_puntual)
tail(Accidentes_pronostico_puntual)

plot(Date_accidentes2,Accidentes_pronostico_puntual, type="l", main = "Estimación puntual de accidentes terrestres en MEX", cex.main=0.8)
```



Comentario sobre el pronóstico puntual sin tendencia ni estacionalidad, que para el caso de la serie de esta serie tiene un valor de:
```{r}
estimacion_puntual_accidentes <- mean(Accidentes_transito_MEX$Num)
estimacion_puntual_accidentes
```

Este valor es bastante concordante con los datos historicos, ya que en general el rango de accidentes se encuentra entre 330 mil y 440 mil, por lo que ese valor de "estimación puntual" sueva bastante razonable 

### A.2 Calculo de intervalos de confianza para el pronóstico

Calculamos los límites de intervalos de confianza al 95% pata el pronostico 
Se considera 95% como +- 2 desviaciones estandar de la media

```{r}
tao<-c(1:3)
Lim_accidentes<-2*sd_est_accidentes*tao^.5
Lim_accidentes
```


Calculamos los limites inferior y superiror como NA para los valores historicos y media +- 2 veces desciación estandar para los valores pronósticados 

Graficamos los valores pronósticadoos t los limites de confianza 

```{r}

LI_accidentes<-c(rep(NA, times=19), Accidentes_pronostico_puntual[1]-Lim_accidentes)
head(LI_accidentes)
tail(LI_accidentes)


LS_accidentes<-c(rep(NA, times=19), Accidentes_pronostico_puntual[1]+Lim_accidentes)
head(LS_accidentes)
tail(LS_accidentes)


plot(Date_accidentes2, accidentes_para_pron, type="l" ,main="Estimación puntual e intervalos de confianza para Accidentes terrestres MEX con el método de 'suavizamiento estático'",col="Blue", cex.main=0.7, ylim=c(200000, 500000))

lines(Accidentes_pronostico_puntual, col="Red")
lines(LI_accidentes, col="Purple")
lines(LS_accidentes, col="Purple")
```

```{r}
#install.packages("readxl")

library("readxl")


Accidentes_transito_MEX_completo <-read_excel("Accidentes_transito_full_.xlsx")
```


Visualizamos el Data.Frame con los valores históricos la "data original" + los resultados del pronóstico puntual y los intervalos de confianza al 95% 

```{r}
df_Accidentes_MX_pronostico<-data.frame(Accidentes_transito_MEX_completo$Num,
                                                Accidentes_pronostico_puntual, LI_accidentes, LS_accidentes)
View(df_Accidentes_MX_pronostico)

tail(df_Accidentes_MX_pronostico)
```


Se observa que los pronósticos puntuales vs los reales parecen no estar muy alejados unos de otros, sin embargo los intervalos de confianza si "sufren DEMASIADO a medida que nos alejamos del último valor real" pues son cada vez más grandes hasta llegar a abarcar un rango de [~260 mil a 517 mil] para el 95% de intervalo de confianza apenas en el 3er valor pronósticado.



### A.5 Calculo del error tipo MAPE para los pronósticos hechos con los modelos estáticos de suavizamiento

Calculemos el error tipo MAPE entre los valores pronosticados con el "método de suavizamiento estático" y los valores reales de la serie 

Para ello importamos el Data Frame con la data historica completa, es decir, la que contiene los 66 trimestres propuestos aquí como "train data" + los 6 trimestres que se pronósticaran


```{r}

##Primero formemos un vector con los valores reales 
accidentes_MEX_completa_reales3 <- Accidentes_transito_MEX_completo$Num[19:22]
accidentes_MEX_completa_reales3

## Despues formemos un vector con únicamente los valores pronósticados 
accidentes_MEX_forecast3 <-  Accidentes_pronostico_puntual[19:22]
accidentes_MEX_forecast3

##Calculemos el MAPE entre estos dos vectores 

# First, calculate the absolute percentage error (APE) for each element in the vectors
APE_accidentes_estatico <- abs((accidentes_MEX_completa_reales3 - accidentes_MEX_forecast3) / accidentes_MEX_completa_reales3)

# Calculate the mean APE across all elements in the vectors
MAPE_accidentes_estatico <- mean(APE_accidentes_estatico) * 100

# Print the MAPE value
cat("El error tipo MAPE  para el forecast calculado con el método de 'suavizamiento estático'de la serie de accidnetes en MEX es:", MAPE_accidentes_estatico, "%")


```



## B. Método de Holt como "modelo de suaviazamiento y pronóstico NO ESTÁTICO" que si considera los cambios de nivel a tráves del tiempo. 

Vamos a usar ahora el método de HoltWinters como "modelo de suaviazamiento y pronóstico NO ESTÁTICO" que si considera los cambios de nivel a tráves del tiempo. 


Para ello debemos tener nuestra data a suavizar en el tipo de dato serie de tiempo ts en R 

```{r}
acidentes_MEX_ts <-ts(Accidentes_transito_MEX$Num, frequency =1, start =c(2000,1))
head(acidentes_MEX_ts)
tail(acidentes_MEX_ts)
```

Graficamos la "data original de la PEA_MEX" que se usará como "train para el modelo" y que fue convertida a tipo de dato serie de tiempo 

```{r}
plot(acidentes_MEX_ts, main="Accidentes MEX train data en tipo time series (Valores de  2000 a 2018)", cex.main=0.8)
```


### Aplicación del método de Holt Winters" a la serie SIN  TENDENCIA y SIN ESTACIONALIDAD de Accidentes terrestres en MX

Como se observará este primer cálculo dejará como grados de libertad los valores de alpha, así como los valores de arranque, de manera que el "el algoritmo de HoltWinters de R" determine la "mejor combinaión posible".
Como en este caso no tenemos componente de seasonalidad ni ne tendencia se indica que el parámetro beta y gamma tendrán un valor "false"

```{r}
accidentes_MEX_ts_h1 <-HoltWinters(acidentes_MEX_ts, beta=FALSE, gamma=FALSE)
accidentes_MEX_ts_h1
```



#### Interpretación de los valores de los coeficientes del método de Holt Winters para el caso de la serie de accidentes terrestres México

Interpretación de los valores de coficientes $\alpha$ y $\beta$ para el caso del pronóstico usando modelo de HoltWinters SIN ESPECIFICAR DATOS DE ARRANQUE    


$$0<\alpha<1$$

Recordemos que: 
Valores de $\alpha$ cercano a 1 reflejan caminata aleatoria
Valores de $\alpha$ cercano a 0 reflejan una "gran influencia" de los valores pasado, es decir, que "el ruido no es un componente de gran relevancia"

En nuestro caso el valor de $\alpha$ es:
```{r}
accidentes_MEX_ts_h1$alpha
```
Lo que indica que nuestra data es prácticamente una caminata aleatoria



### Pronóstico de la serie de PEA en MEX con el método de Holt Winters 

Ahora pasemos a realizar los pronósticos de la serie pero con el método de HoltWinters que considera cambios dinámicos de nivel 

Graficamos los valores originales vs suavizados con el método de Holt-Winters


```{r}
plot(accidentes_MEX_ts_h1, main="Aplicaicón del método de Holt Winters a accidentes MEX train data")
```


```{r}
# Install the forecast package
#install.packages("forecast")

# Load the forecast package
library(forecast)
```



Ahora se llevará a cabo el pronóstico con la librería de forecast y basados en el método de Holt Winters. De igual manera se usará un intervalo de confianza del 95%

```{r}
accidentes_MEX_ts_h1_fc <- forecast(accidentes_MEX_ts_h1, h=3, level=0.95)
accidentes_MEX_ts_h1_fc
```


```{r}
plot(accidentes_MEX_ts_h1_fc, main="Forecast de Accidentes MX usando el Método de Holt Winters con parámetro gamma ='False'", cex.main=0.8)
```


Se observa como el prronostico puntual es "relativamente bueno" y es parecido en valor al obtenido previamente con el método estático, sin embargo los Intervalos de confianza obtenidos con este método son MEJORES en comparación con los del anterior 




Veamos el valor la Suma de Errores al Cuadrado del pronóstico de PEA en MEX  usando el Método de suaviazamiento dinámico de HoltWinters
```{r}
accidentes_MEX_ts_h1$SSE
```



Calculemos el error tipo MAPE entre los valores pronosticados con el "método de Holt Winters" y los valores reales de la serie 

```{r}
accidentes_MEX_completa_forecast3_HW  <- accidentes_MEX_ts_h1_fc$mean[1:3]
accidentes_MEX_completa_forecast3_HW
```


```{r}

##Calculemos el MAPE entre estos dos vectores 

# First, calculate the absolute percentage error (APE) for each element in the vectors
APE_accidentes_HW <- abs((accidentes_MEX_completa_reales3 - accidentes_MEX_completa_forecast3_HW) / accidentes_MEX_completa_reales3)

# Calculate the mean APE across all elements in the vectors
MAPE_accidentes_HW <- mean(APE_accidentes_HW) * 100

# Print the MAPE value
cat("MAPE error para el forecast calculado con el método de 'HoltWinters'es:", MAPE_accidentes_HW, "%")
```



### Comparación del MAPE del pronostico hecho con métodos estáticos vs el pronóstico hecho con el método " de suavizamiento dinámico" de HoltWinters para el pronostico puntual


En este caso y dado un cálculo con el métodO de HolttWinters sin valores de arranque especificados los errores de ambos métodos (estático vs HoltWinters) fueron los sigientes: 


```{r}
cat("MAPE error para el forecast calculado con el método de 'suavizamiento estático'es:", MAPE_accidentes_estatico, "%")

  
cat("MAPE error para el forecast calculado con el método de 'HoltWinters'es:", MAPE_accidentes_HW, "%")
```

Lo que indica que para este caso el Método de HoltWinters fue ligeramente mejor para el cálculo de las estimaciones puntuales  


### Comparación de los intervalos del pronostico hecho con métodos estáticos vs el pronóstico hecho con el método " de suavizamiento dinámico" de HoltWinters 

Como se sabe, la parte "más sustancial" o esencial de los pronósticos es el intervalo y no el pronóstico puntual, por lo que en nuestro caso se considerará en general como "un mejor mpetodo de pronóstico" no aquel que otorge el menor error tipo MAPE en las estimaciones puntuales, sino aquel cuyos intervalos de confianza al 95% sean menores incluso para valores pronósticados relativamente lejanos del último valor real. 



Se observa claramente como el método de HoltWinters otorga mejores intervalos de confianza para pronósticos incluso para aquellos 'más alejados' del último valor real vs aquellos generados con el "método de suavizamiento estático" 














Calculemos el error tipo MAPE entre los valores pronosticados con el "método de Holt Winters" y los valores reales de la serie 

```{r}

## Formemos un vector con únicamente los valores reales de los ultimos 6 trimestres 
PEA_completo_realest6 <- PEA_MEX_completa$PEA[67:72]
PEA_completo_realest6


## Formemos un vector con únicamente los valores pronósticados 
PEA_HW_forecast6 <- PEA_MEX_ts_h1_fc$mean
PEA_HW_forecast6



```


```{r}

##Calculemos el MAPE entre estos dos vectores 

# First, calculate the absolute percentage error (APE) for each element in the vectors
APE_PEA_HW <- abs((PEA_completo_realest6 - PEA_HW_forecast6) / PEA_completo_realest6)

# Calculate the mean APE across all elements in the vectors
MAPE_PEA_HW <- mean(APE_PEA_HW) * 100

# Print the MAPE value
cat("MAPE error para el forecast calculado con el método de 'HoltWinters'es:", MAPE_PEA_HW, "%")
```



### Error cuadrado calculado con el Método de HoltWinters vs el calculado con el método de suafizamiento estático 


```{r}
PEA_MEX_ts_h1$SSE
```

Entonces el error asociado al pronóstico del cálculo de pronóstico PUNTUAL para el caso Demanda_eléctirco es:  
```{r}
sse_PEA_hw <- ((PEA_MEX_ts_h1$SSE)/(length(PEA_MEX_ts)))^0.5
sse_PEA_hw
```


Recordar que la SSE de la demanda_electrico para el caso del método de suavizamiento estático era:
```{r}
SSE_PEA_E <- sum(PEA_MX_ruido_blanco^2)
SSE_PEA_E
```

Lo que indica que el método de suavizamiento estático resultó bastante mejor en nuestro caso para el PRONOSTICO PUNTUAL de la demanda de gas natural en el sector eléctrico en México vs el método de HoltWinters



### Comparación del MAPE del pronostico hecho con métodos estáticos vs el pronóstico hecho con el método " de suavizamiento dinámico" de HoltWinters para el pronostico puntual


En este caso y dado un cálculo con el métodO de HolttWinters sin valores de arranque especificados los errores de ambos métodos (estático vs HoltWinters) fueron los sigientes: 


```{r}
cat("MAPE error para el forecast calculado con el método de 'suavizamiento estático'es:", MAPE_PEA_estatico, "%")

  
cat("MAPE error para el forecast calculado con el método de 'HoltWinters'es:", MAPE_PEA_HW, "%")
```

Lo que confirma que el método de suavizamiento estático resultó mejor en nuestro caso para el PRONOSTICO PUNTUAL de la PEA en México. 


### Comparación de los intervalos del pronostico hecho con métodos estáticos vs el pronóstico hecho con el método " de suavizamiento dinámico" de HoltWinters 

Como se sabe, la parte "más sustancial" o esencial de los pronósticos es el intervalo y no el pronóstico puntual, por lo que en nuestro caso se considerará en general como "un mejor mpetodo de pronóstico" no aquel que otorge el menor error tipo MAPE en las estimaciones puntuales, sino aquel cuyos intervalos de confianza al 95% sean menores incluso para valores pronósticados relativamente lejanos del último valor real. 



Intervalos calculados con el método de suavizamiento estático
```{r}
LI_PEA_ajustado[67:72]
LS_PEA_ajustado[67:72]


intervalos_metodo_E<- data.frame(LI_PEA_ajustado_E =LI_PEA_ajustado[67:72], LS_PEA_ajustado_E= LS_PEA_ajustado[67:72])

intervalos_metodo_E

```



Intervalos calculados con el método de suavizamiento dinámico Holt-Witers
```{r}
PEA_MEX_ts_h1_fc
```

Se observa claramente como el método de HoltWinters otorga mejores intervalos de confianza para pronósticos incluso para aquellos 'más alejados' del último valor real vs aquellos generados con el "método de suavizamiento estático" 





