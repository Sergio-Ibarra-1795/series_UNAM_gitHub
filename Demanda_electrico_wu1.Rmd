---
title: "Demanda_electrico_wu"
author: "Sergibar"
date: "2023-03-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Serie de tiempo CON tendencia y CON estacionalidad


Primero vamos a importar la data 

```{r}
install.packages("readxl")

library("readxl")
```


```{r}

Demanda_electrico <-read_excel("Demanda_electrico_2022_full1.xlsx")
```



Revisamos que la data se haya importado correctamente 
```{r}
head(Demanda_electrico)
summary(Demanda_electrico)
typeof(Demanda_electrico)
dim(Demanda_electrico)
```

Graficamos la "demanda original"

```{r}
plot(Demanda_electrico$Demanded_Gas, type = "l")
```


### Primero se calculará la linea "general" de tendencia de nuestra serie de demanded_gas y se removerá de la 'data original de demanda_electrico'


```{r}

Electrico_Demanded_gas_line<-lm(Demanded_Gas~Date, data=Demanda_electrico)

Electrico_Demanded_gas_line


```



### Graficamos la "serie original" de demanda_electrico vs el filtro 

Para eso primero debemos crear nuestra linea de tendencia con base en la Electrico_Demanded_gas_line calculada a partir de la data 
```{r}
Electrico_Demanded_gas_line_aplicada <- predict(Electrico_Demanded_gas_line, newdata = data.frame(Date = Demanda_electrico$Date))

Electrico_Demanded_gas_line_aplicada

```


Graficamos entonces a la "data original de demanda electrico" y a la data calculada con linea tendencia

```{r}
plot(Demanda_electrico$Demanded_Gas, type="l")
lines(Electrico_Demanded_gas_line_aplicada, col = "red")
```



### Ahora vamos a "quitar el efecto de la tendencia" de nuestra "serie original de datos"

```{r}
Demanda_electrico_Sin_Tendencia<-Demanda_electrico$Demanded_Gas/Electrico_Demanded_gas_line_aplicada

plot(Demanda_electrico_Sin_Tendencia, type="l")
Demanda_electrico_Sin_Tendencia
dim(Demanda_electrico_Sin_Tendencia)
```


```{r}
# Generate indices for T1, T2, T3, and T4
# Define the indices for each subset
T1_indices <- c(seq(1, 3), seq(13, 15), seq(25, 27), seq(37, 39), seq(49, 51), seq(61, 63), seq(73, 75), seq(85, 87), seq(97, 99), seq(109, 111), seq(121, 123), seq(133, 135), seq(145, 147), seq(157, 159), seq(169, 171), seq(181, 183), seq(193, 195), seq(205, 207))


T2_indices <- c(seq(4, 6), seq(16, 18), seq(28, 30), seq(40, 42), seq(52, 54), seq(64, 66), seq(76, 78), seq(88, 90), seq(100, 102), seq(112, 114), seq(124, 126), seq(136, 138), seq(148, 150), seq(160, 162), seq(172, 174), seq(184, 186), seq(196, 198), seq(208, 210))

T3_indices <- c(seq(7, 9), seq(19, 21), seq(31, 33), seq(43, 45), seq(55, 57), seq(67, 69), seq(79, 81), seq(91, 93), seq(103, 105), seq(115, 117), seq(127, 129), seq(139, 141), seq(151, 153), seq(163, 165), seq(175, 177), seq(187, 189), seq(199, 201), seq(211, 213))

T4_indices <- c(seq(10, 12), seq(22, 24), seq(34, 36), seq(46, 48), seq(58, 60), seq(70, 72), seq(82, 84), seq(94, 96), seq(106, 108), seq(118, 120), seq(130, 132), seq(142, 144), seq(154, 156), seq(166, 168), seq(178, 180), seq(190, 192), seq(202, 204), seq(214, 216))


# Create the subsets
T1 <- Demanda_electrico_Sin_Tendencia[T1_indices]
T1
T2 <- Demanda_electrico_Sin_Tendencia[T2_indices]
T2
T3 <- Demanda_electrico_Sin_Tendencia[T3_indices]
T3
T4 <- Demanda_electrico_Sin_Tendencia[T4_indices]
T4



```


Calculamos los Factores Estacionarios de la Serie 

```{r}

FE1_electrico<-mean(T1)/mean(Demanda_electrico_Sin_Tendencia)
FE1_electrico

FE2_electrico<-mean(T2)/mean(Demanda_electrico_Sin_Tendencia)
FE2_electrico

FE3_electrico<-mean(T3)/mean(Demanda_electrico_Sin_Tendencia)
FE3_electrico

FE4_electrico<-mean(T4, na.rm = TRUE)/mean(Demanda_electrico_Sin_Tendencia)
FE4_electrico
```

Una vez calculados los factores estacionales de la serie se puede calcular el ruido que sería quitando el efecto de esos factores a nuestra serie sin tendencia 
```{r}

Demanda_electrico_ruido<-Demanda_electrico_Sin_Tendencia/c(FE1_electrico, FE2_electrico, FE3_electrico, FE4_electrico)

Demanda_electrico_ruido

plot(Demanda_electrico_ruido, type="l")
```


Determinamos el filtro sin tendencia ni estacionalidad para nuestra serie de demanda_electrico 
```{r}

demanda_electrico_filtro_sinTendencia_NiEstacionalidad <-Demanda_electrico_ruido-mean(Demanda_electrico_ruido)

plot(demanda_electrico_filtro_sinTendencia_NiEstacionalidad, type="l")

```


Ahora llevamos a cabo el pronostico 
```{r}

Demanda_electrico_pronostico<-c(Demanda_electrico_ruido, rep(mean(Demanda_electrico_ruido), 12))

plot(Demanda_electrico_pronostico, type="l")

```


Calculamos los límites de pronostico 

```{r}
LI_demanda_electrico<-Demanda_electrico_pronostico[214:225]-2*sd(Demanda_electrico_ruido)*c(1:12)^.5
LS_demanda_electrico<-Demanda_electrico_pronostico[214:225]+2*sd(Demanda_electrico_ruido)*c(1:12)^.5

LI_demanda_electrico_ajustado<-c(rep(NA, times=213), LI_demanda_electrico)
LI_demanda_electrico_ajustado

LS_demanda_electrico_ajustado<-c(rep(NA, times=213), LS_demanda_electrico)
LS_demanda_electrico_ajustado
```


Ahora vamos a "llevar nuestro pornóstico a las dimensiones reales"
Para ello primero vamos a "devolver la esacionalidad a la serie"
```{r}

# Devolver estacionalidada

Demanda_electrico_cest<-Demanda_electrico_pronostico*c(FE1_electrico, FE2_electrico,FE3_electrico, FE4_electrico)
Demanda_electrico_cest


LI_demanda_electrico_cest<-LI_demanda_electrico_ajustado*c(FE1_electrico, FE2_electrico,FE3_electrico, FE4_electrico)
LI_demanda_electrico_cest



LS_demanda_electrico_cest<-LS_demanda_electrico_ajustado*c(FE1_electrico, FE2_electrico,FE3_electrico, FE4_electrico)
LS_demanda_electrico_cest


plot(Demanda_electrico_cest, type="l")
lines(LI_demanda_electrico_cest, col="violet")
lines(LS_demanda_electrico_cest, col="violet")
```


Y ahora "Devolvemos el efecto de la tendencia"


```{r}


# create a new data set with 12 additional months
extended_dates_electrico <- seq(as.Date("2005-01-01"), as.Date("2023-09-01"), by = "month")
extended_dates_electrico

extended_demanda_electrico <- data.frame(Date = extended_dates_electrico, 
                                       Demandes_Gas = rep(NA, length(extended_dates_electrico)))

extended_demanda_electrico


# copy the original data to the new data set
extended_demanda_electrico$Demanded_Gas[1:length(Demanda_electrico$Demanded_Gas)] <-Demanda_electrico$Demanded_Gas


extended_demanda_electrico


```


```{r}


# fit the model with the extended data set
linea_nacimientos_extended <- lm(Births ~ Date, data = extended_nacimientos_mex)
linea_nacimientos_extended




# predict values for the extended date range
Demanda_electrico_tendencia_extended <- predict(linea_nacimientos_extended, 
                                                newdata = data.frame(Date = extended_dates))
linea_nacimientos_aplicada_extended

# plot the predicted values
plot(extended_dates, linea_nacimientos_aplicada_extended, type = "l")

```



```{r}



Demanda_electrico_pronostico_fin<-Demanda_electrico_cest*Demanda_electrico_tendencia

LI_demanda_electrico_fin<-LI_demanda_electrico_cest*Demanda_electrico_tendencia
LS_demanda_electrico_fin<-LS_demanda_electrico_cest*Demanda_electrico_tendencia


plot(Demanda_electrico_pronostico_fin, type="l", ylim=c(0, max(LS_demanda_electrico_fin, na.rm = TRUE)))
lines(LI_demanda_electrico_fin, col="violet")
lines(LS_demanda_electrico_fin, col="violet")

df_demanda_electrico_pronostico<-data.frame(Demanda_electrico_pronostico_fin, LI_demanda_electrico_fin, LS_demanda_electrico_fin)
View(df_demanda_electrico_pronostico)
```



